#!/bin/bash

DATAFILE=$HOME/.dotfiles/tmp/namaz

function namaz_guncelle {
  # get prayer times from api.namazvakitleri.com.tr
  # and write to $DATAFILE as one timestamp per line
  # local url='http://api.namazvakitleri.com.tr/getTimes/json/217'
  local url='http://api.namazvakitleri.com.tr/getTimes/json/185'
  date -f <(curl --silent  $url | \
            command sed -r 's/\{/\n{/g;s/(\{|")[ a-zD"},:]+/ /g' |\
            tail -n +6 |\
            awk '{for(i=3;i<9;i++)printf "%sT%s\n", $1, $i}') +%s > \
            $DATAFILE
}

function namaz_temizle {
  local TODAY=$(date --date="0:00 today" +%s)
  local i=0
  local line
  while read line; do
    if [[ $line -gt $TODAY ]]; then
      break
    fi
    let i++
  done < $DATAFILE
  if [[ $i -gt 0 ]]; then
    sed -i "1,${i}d" $DATAFILE
  fi
}

function namaz_next {
  local CURTIME=$(date +%s)
  local line
  local i=0
  while read line; do
    let i++
    if [[ $line -gt $CURTIME ]]; then
      break
    fi
  done < $DATAFILE
  echo $line $i
}

function namaz_yaz {
  echo    "   Tarih    | Sabah | Imsak | Ogle  | Ikindi| Aksam | Yatsi"
  echo -n "------------+-------+-------+-------+-------+-------+-------"

  i=0
  while read line; do
    if [[ $((i%6)) == 0 ]]; then
      if [[ $((i/6)) == ${1:-7} ]]; then
        echo
        exit 0
      fi
      echo -ne "\n $(date --date=@$line '+%d-%m-%Y | %H:%M')"
    else
      echo -n " | $(date --date=@$line '+%H:%M')"
    fi
    let i++
  done < $DATAFILE
  echo
}

function namaz_kalan {
  local a=( $(namaz_next) )
  local kalan=$((${a[0]}-$(date +%s)))
  echo $(( $kalan/3600 ))sa$(( ($kalan%3600)/60 ))dk $kalan
}

if [[ ! -s $DATAFILE ]]; then
  # echo "Downloading the prayer times"
  touch $DATAFILE
  namaz_guncelle
fi
namaz_temizle

if [[ -s $DATAFILE ]]; then
  if [[ $# == 0 ]]; then
    namaz_yaz
  elif [[ $1 == [0-9]* ]]; then
    namaz_yaz $1
  elif [[ $1 == up ]]; then
    namaz_guncelle
    namaz_temizle
  elif [[ $1 == next ]]; then
    namaz_next
  elif [[ $1 == kalan ]]; then
    namaz_kalan
  fi
fi

# vim: ft=sh
