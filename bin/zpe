#!/bin/bash
# set -x
if [[ $# == 0 ]]; then
  echo "usage: zpe atom1 atom2..."
  exit
fi
n=$#
nat=$(sed -n '/nat/s/.*=\s*//p' input.txt)
l=$(grep -n ATOMIC_P input.txt|cut -d: -f1)
s=$(grep -n '&system' input.txt|cut -d: -f1)
all=""
header="&control
  restart_mode        = 'from_scratch'
  max_seconds         = 10000
  tprnfor             = .true.
/
""$(sed -n $s,${l}p input.txt| sed "/&electrons/a\  startingwfc = \'file\'\n\  startingpot = \'file\'")"

for ((i=1; i<=n; i++)); do
  for j in {1..6}; do
    all="${all} $i/$j"
    mkdir -p $i/$j
    echo "${header}" > $i/$j/input.txt
    awk -va=$1 -vl=$l -vj=$j 'BEGIN{
      x = y = z = 0
      if(j < 3) {x = 1} else if(j < 5) {y = 1} else { z = 1 }
      if(j % 2 == 1) { x = -x; y = -y; z = -z}
    } NR > l {
      if (NR == l + a){
        printf "  %-4s %14.9f %14.9f %14.9f\n", $1, $2 + 0.01 * x, $3 + 0.01 * y, $4 + 0.01 * z
        i++
      } else {
        print $0
      }
    }' input.txt >> $i/$j/input.txt
  done
  shift
done

cat <<-EOF > zpe.job
	#!/bin/bash
	#PBS -l nodes=6:ppn=8,walltime=02:00:00
	#PBS -q cfn_regular
	#PBS -j oe
	#PBS -m ae
	#PBS -M sselcuk@ofis.princeton.edu
	#PBS -V

	module load intel openmpi/1.4.2-intel

	kpools=1
	images=1
	gap=300
	exec="pw.x"
	exec_path="\$HOME/software/espresso-5.0.2/bin"

	cd \$PBS_O_WORKDIR
	numprocs=\`wc -l <\${PBS_NODEFILE}\`

	for i in ${all};do
	  cp pwscf.* \$i
	  cd \$i
	  maxseconds=\$(qstat -f \$PBS_JOBID | awk '{if(\$1=="Resource_List.walltime"){split(\$3, tmp, ":");print tmp[1]*3600+tmp[2]*60+tmp[3]-gap;}}' gap=\$gap)
	  sed -i "s/\(max_seconds *= *\)[0-9]*,/\1\$maxseconds,/" input.txt
	  mpiexec -np \$numprocs \$exec_path/\$exec -npool \$kpools -nimages \$images -inp input.txt >> output.txt
	  rm -rf pwscf.*
	  cd ../..
	done
EOF
