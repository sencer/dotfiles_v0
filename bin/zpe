#!/bin/bash
if [[ -z $PBSSERVER ]]; then
  if [[ $# == 0 ]]; then
    echo "usage: zpe atom1 atom2..."
    echo
    echo "Atomic coordinates in the original input file"
    echo "must be listed in Angstroms."
    exit
  fi
  n=$#
  all=( $@ )
  inp=`basename $PWD`.txt
  if [[ ! -f $inp ]]; then
    echo 'First you should generate a pwscf input file using `pin`'
    exit -1
  fi
  mkdir -p zpe
  cp $inp zpe/input.txt
  cd zpe
  nat=$(sed -n '/nat/s/.*=\s*//p' input.txt)
  l=$(grep -n ATOMIC_P input.txt|cut -d: -f1)
  s=$(grep -n '&system' input.txt|cut -d: -f1)
  header="&control
  restart_mode        = 'from_scratch'
  max_seconds         = 10000
  tprnfor             = .true.
  /
  $(sed -n $s,${l}p input.txt |\
    sed "/&electrons/a\  startingwfc = \'file\'\n\  startingpot = \'file\'")"

  for i in ${all[@]}; do
    for j in {1..6}; do
      mkdir -p $i/$j
      echo "${header}" > $i/$j/input.txt
      awk -va=$1 -vl=$l -vj=$j 'BEGIN{
        x = y = z = 0
        if(j < 3) {x = 1} else if(j < 5) {y = 1} else { z = 1 }
          if(j % 2 == 1) { x = -x; y = -y; z = -z}
          } NR > l {
          if (NR == l + a){
            printf "  %-4s %14.9f %14.9f %14.9f\n", $1, $2 + 0.01 * x, $3 + 0.01 * y, $4 + 0.01 * z
            i++
          } else {
          print $0
        }
      }' input.txt >> $i/$j/input.txt
    done
    shift
  done

  apply_conf $HOME/$PBSSERVER/.jobconfig -if -all "${all[*]}" -kpools 1 -gap 300 -images 1 <<-'EOF' > zpe.job
		#!/bin/bash
		#PBS -l $lline
		#PBS -q $queue
		#PBS -j oe
		#PBS -m ae
		#PBS -M $email
		#PBS -V
	
		module load $modules
	
		gap=$gap
		kpools=$kpools
		images=$images
	
		cd \$PBS_O_WORKDIR
		numprocs=\`wc -l <\${PBS_NODEFILE}\`
	
		for i in ${all}; do
		  for j in {1..6};do
		    cp -r ../pwscf.* \$i/\$j
		    cd \$i/\$j
		    maxseconds=\$(qstat -f \$PBS_JOBID | awk '{if(\$1==\"Resource_List.walltime\"){split(\$3, tmp, \":\");print (tmp[1]*3600+tmp[2]*60+tmp[3])/(6*\$n)-gap;}}' gap=\$gap)
		    sed -i "\"s/\(max_seconds\\s*=\\s*\)[0-9]*/\\1\$maxseconds/\"" input.txt
		    $scheduler $prepara \$numprocs $path/pw.x -npool \$kpools -nimages \$images -inp input.txt >> output.txt
		    rm -rf pwscf.*
		    cd ../..
		  done
		done
	EOF
else
  ras "~/bin/zpe $@"
fi
