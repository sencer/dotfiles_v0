#!/bin/bash
# set -x

cd $HOME/.pbsjobs/
# read atime mtime file name's into stat array.
read -a stat <<< $(stat -c '%X %Y %n' msg.* 2>/dev/null)

echoe(){
  echo "$@" 1>&2
}

# get filenames of unread emails
function unread(){
  unread=""
  read=""
  for (( i = 0; i < ${#stat[@]}; i+=3 )); do
    if [[ ${stat[i]} == ${stat[i+1]} ]]; then # if mtime <> atime
      unread=$unread" "${stat[i+2]}
    else
      read=$read" "${stat[i+2]}
    fi
  done
  if [[ -n $1 ]]; then
    echo $read
  else
    echo $unread
  fi
}

function parse(){
  local job=( $(sed -nr '/PBS Job Id/,+1H;g;${s/\n|[.-]/ /gp}' $1)} )
  local path=$(PBS_SERVER=${job[4]} get_job_folder -n ${job[3]})
  printf "%-7s %8s %10s %s\n" ${job[4]} ${job[3]} ${job[10]} ${path:-"NA"}
}

function log(){
  files=$(unread)
  if [[ ! -z $files ]]; then
    date
    for i in $files; do
      parse $i
    done
  else
    echoe "No new mail."
  fi
}

function clean(){
  files=$(unread 1)
  if [[ ! -z $files ]]; then
    rm -f $files
  fi
}

log|tee -a $HOME/.dotfiles/tmp/mails.log
clean
