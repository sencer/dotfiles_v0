#!/bin/bash
# cn universityid seealso telephonenumber studenttelephonenumber
# facsimiletelephonenumber street studentstreet ou mail emailbox uid
# voicemailbox labeleduri pudisplayname
echo "Results:"
ldapsearch -l 30 \
           -LLL  \
           -x \
           -h ldap.princeton.edu \
           -S pudisplayname \
           -b "o=Princeton University,c=US" \
           "(|(cn=*$1*)(uid=*$1*))" \
           pudisplayname \
           ou \
           telephonenumber \
           mail |\
           awk -vq="^${1,,}" '{
             split($0, line, ": ")
             switch(line[1]){
               case "pudisplayname":
                 split(line[2], name, ", ")
                 break
               case "ou":
                 department = line[2]
                 break
               case "telephonenumber":
                 department = department ", " line[2]
                 break
               case "mail":
                 if(!name[2]){
                   name[1]="?"
                   name[2]="?"
                 }
                 result = sprintf("%s\t%s\t%s", line[2],\
                   name[2] ? name[2] " " name[1] : "???", department)
                 if(tolower(name[2]) ~ q || tolower(name[1]) ~ q || tolower(line[2]) ~ q)
                   priority[i++] = result
                 else
                   other[j++] = result
                 break
             }
           } END {
             for(k in priority)
               print priority[k]
             for(k in other)
               print other[k]
         }'
