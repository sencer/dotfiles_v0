#!/usr/bin/env bash

function switch(){
  arg=$1
  if [ "${server=`grep "^$arg " $PBS_SERVER_FILE`}" ]; then
    read -a settings <<< "$server"
  else
    echo "Settings for $arg not found"
    exit
  fi
  
  if [ -d ~/$arg ]; then
    [[ "$PWD" == $HOME/$arg* ]] && cd ~
    fusermount -z -u ~/$arg 2>/dev/null || echo "$arg is not mounted"
    rmdir ~/$arg || echo "~/$arg cannot be deleted"
    # if [ ${settings[4]} -gt 0 ]; then
    #   tmp=$(netstat -atnp 2>/dev/null|grep '127.0.0.1:'${settings[4]} |grep '0.0.0.0'|tr -s ' '|cut -d " " -f 7)
    #   kill ${tmp/\/ssh/}
    # fi
  else
    # if [ ${settings[4]} -gt 0 ]; then
    #   ssh -L ${settings[4]}:${settings[5]}:22 ${settings[6]} -fq "sleep 1" 
    # fi
    mkdir -p ~/$arg
    nohup &>/dev/null sshfs ${settings[1]}:${settings[3]} ~/$arg -o transform_symlinks,follow_symlinks,workaround=rename,idmap=user||server $arg
    # ,ssh_command="ssh -S none",no_readahead,cache=no
  fi
}

while [[ $# -gt 0 ]]; do
 switch $1
 shift
done
ls --color=auto ~
