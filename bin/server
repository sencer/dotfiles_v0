#!/usr/bin/env bash

function switch(){
  arg=$1
  if [[ "${PBS_SERVER_LIST}" != *:$arg:* ]]; then
    echo "Server $arg is not defined."
    exit 0
  fi
  if [ -d $HOME/$arg ]; then
    fusermount -z -u $HOME/$arg 2>/dev/null || echo "$arg is not mounted"
    rmdir $HOME/$arg || echo "$HOME/$arg cannot be deleted"
  else
    mkdir -p $HOME/$arg
    sshfs $1:. $HOME/$arg -C -o reconnect,transform_symlinks,follow_symlinks,workaround=rename,idmap=user,ssh_command="ssh -S none"||server $arg
    # ,ssh_command="ssh -S none",no_readahead,cache=no
  fi
}

while [[ $# -gt 0 ]]; do
 switch $1
 shift
done
ls --color=auto $HOME
