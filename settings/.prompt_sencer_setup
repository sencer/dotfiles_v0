#
# A monochrome theme that displays basic information.
#
# Authors:
#   Brian Tse <briankftse@gmail.com>
#   Sorin Ionescu <sorin.ionescu@gmail.com>
#
# Screenshots:
#   http://i.imgur.com/zLZNK.png
#


function prompt_sencer_precmd {
  local DATAFILE=$HOME/.dotfiles/data/namaz
  export NAMAZ=$(head -1 $DATAFILE)
  if [[ $(wc -l < $DATAFILE) -lt 15 ]]; then
    prompt_namaz_guncelle
  fi
  while [[ $NAMAZ -le $[`date +%s`+daylight*60] ]]; do
    sed -i 1d $DATAFILE
    export NAMAZ=$(head -1 $DATAFILE)
  done
  prompt_weather_timer
}

function prompt_namaz_guncelle {
  local DATAFILE=$HOME/.dotfiles/data/namaz
  local url='http://api.namazvakitleri.com.tr/getTimes/json/217'
  date -f <(curl --silent  $url | \
            command sed -r 's/\{/\n{/g;s/(\{|")[ a-zD"},:]+/ /g' |\
            tail -n +6 |\
            awk '{for(i=3;i<9;i++)printf "%sT%s\n", $1, $i}') +%s >! \
            $DATAFILE
}

function prompt_weather_update(){
  local weather
  weather=( $(curl --silent "http://xml.weather.yahoo.com/forecastrss?p=USNJ0427&u=c" | grep condition | command sed -r 's/[^0-9-]+/ /g') )
  export WEATHER="$(date +%s) $weather[1] $weather[2]Â°C"
}

function prompt_weather_timer(){
  local tmp
  tmp=( ${=WEATHER} )
  if [[ $[$(date +%s)-tmp[1]] -lt 3600 || -z $WEATHER ]]; then
    prompt_weather_update
  fi
}

function prompt_kalan_vakit {
  local kalan daylight
  local loc=-5
  [[ $NAMAZ -lt 0 ]] && exit
  if [ `date +%:::z` -eq $loc ];then
    daylight=0
  else
    daylight=3600
  fi
  kalan=$[NAMAZ-`date +%s`-daylight]
  echo "[$[kalan/3600]sa$[(kalan%3600)/60]dk]"
}

function prompt_sencer_setup {
  prompt_opts=(cr percent subst)
  # Define prompts.
  export PROMPT="%F{73}%h:%F{174}%C%f " 

  if [[ -n $TMUX ]]; then
    export RPROMPT="%F{73}[\${PWD/${HOME//\//\\/}/~}]%f"
  else
    # Load required functions.
    autoload -Uz add-zsh-hook

    # Add hook for calling vcs_info before each command.
    add-zsh-hook precmd prompt_sencer_precmd

    export RPROMPT="%F{73}\$(prompt_kalan_vakit)[\${PWD/${HOME//\//\\/}/~}]%f"
  fi
}

prompt_sencer_setup "$@"

# vim: ft=zsh
